%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Plantilla para un artículo en LaTeX en español.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass{article}

% Esto es para poder escribir acentos directamente:
\usepackage[latin1]{inputenc}
% Esto es para que el LaTeX sepa que el texto está en español:
\usepackage[spanish]{babel}

% Paquetes de la AMS:
\usepackage{amsmath, amsthm, amsfonts}

% Paquete para generar grafos
\usepackage{tikz}
% Paquete para tratar con imágenes
\usepackage{graphicx}

% Teoremas
%--------------------------------------------------------------------------
\newtheorem{thm}{Teorema}[section]
\newtheorem{cor}[thm]{Corolario}
\newtheorem{lem}[thm]{Lema}
\newtheorem{prop}[thm]{Proposición}
\theoremstyle{definition}
\newtheorem{defn}[thm]{Definición}
\theoremstyle{remark}
\newtheorem{rem}[thm]{Observación}

% Atajos.
% Se pueden definir comandos nuevos para acortar cosas que se usan
% frecuentemente. Como ejemplo, aquí se definen la R y la Z dobles que
% suelen representar a los conjuntos de números reales y enteros.
%--------------------------------------------------------------------------

\def\RR{\mathbb{R}}
\def\ZZ{\mathbb{Z}}

% De la misma forma se pueden definir comandos con argumentos. Por
% ejemplo, aquí definimos un comando para escribir el valor absoluto
% de algo más fácilmente.
%--------------------------------------------------------------------------
\newcommand{\abs}[1]{\left\vert#1\right\vert}

% Operadores.
% Los operadores nuevos deben definirse como tales para que aparezcan
% correctamente. Como ejemplo definimos en jacobiano:
%--------------------------------------------------------------------------
\DeclareMathOperator{\Jac}{Jac}

%--------------------------------------------------------------------------
\title{Memoria de la práctica 5 de RPI1}
\author{Jose Fabrizio Alcaraz Escobar y Daniel Mihai Rece}

\begin{document}
\maketitle


\section{Introducción}

Comenzamos la práctica haciéndonos con las herramientas necesarias: \b{hcitool} para gestionar la interfaz Bluethoot y \b{gatttool} para la conexión e iteracción con la tabla GATT. En este caso, nuestro dispositivo constará del nombre configurado "ESP\_GATS\_FADA" y la MAC por defecto c4:dd:57:5b:fd:12 (tal y como se muestra en la imagen \ref{lescan}).

\begin{figure}[!h]%
  \centering
  \includegraphics[width=60mm]{hcitool-lescan.png}
  \caption{CLI hcitool lescan}
  \label{lescan}
\end{figure}

Una vez accedemos al dispositivo haciendo uso de gatttool, procedemos a conectarnos mediante el comando connect para inmediatamente lanzar help y estudiar los comandos disponibles. Nuestro objetivo es identificar la característica asociada a la constante GATTS\_CHAR\_UUID\_TEST\_A de valor $0xFF01$ de nuestro programa, que, a su vez, es la que gestiona las variables char\_value que vamos a querer leer. Una vez identificada gracias a los valores precedentes al primer guión de la uuid (consultar imagen \ref{char}), procedemos a leer el valor de la variable anteriormente mencionada por medio del comando char-read-hnd seguido del "char value handle" de la característica.

\begin{figure}[!h]%
  \centering
  \includegraphics[width=60mm]{char-identifi.png}
  \caption{CLI gatttool char identification}
  \label{char}
\end{figure}

Tras haber accedido a estos valores, observamos que tenemos 2 maneras de modificarlos. Una de ellas es por medio del programa base o main, al que accederemos y modificaremos su código para volver a compilar y flashear nuestra tarjeta ESP-32. La segunda opción (no es permanente y volverá al valor original tras la desconexión de la placa) consiste en usar la propia consola que nos ofrece gatttool: haciendo uso del comando char-write-cmd seguido del "char value handle" de la característica y proporcionándole un nuevo valor.


Para finalizar los preparativos, accedemos al siguiente "char value handle", asociado a la configuración de la característica anterior. Esto nos permite enviar comandos de configuración que permitan realizar x o y acción, se mostrará en el ejercicio con más detalle.



\section{Ejercicio}

El ejercicio consiste en programar una tarea que monitorice parámetros (en este caso aleatorios) y los muestre a todo aquel interesado en obtenerlo por medio de la herramienta gatttool. Para este fin, creamos una tarea que cada segundo irá actualizando la variable char-value y la enviará a aquel que se suscriba. Para realizar una suscripción, el cliente tendrá que escribir un comando de configuración 0100; para cancelar la suscripción, bastará con enviar un comando de configuración 0000. En las imágenes \ref{rw} y \ref{t} adjuntas, se muestra como funcionan ambos comandos desde la perspectiva del cliente y del servidor respectivamente.

\begin{figure}[!h]%
  \centering
  \includegraphics[width=60mm]{read-write-sub-unsub.png}
  \caption{Client (sub-unsub)scribe}
  \label{rw}
\end{figure}
\begin{figure}[!h]%
  \centering
  \includegraphics[width=60mm]{teminal.png}
  \caption{Server (sub-unsub)scribe}
  \label{t}
\end{figure}





\end{document}
